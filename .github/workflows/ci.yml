name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go: ['1.21', '1.22', '1.23']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ matrix.go }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.go }}-
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run tests
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            go test -v -race ./...
          else
            go test -v -race -coverprofile=coverage.out ./...
          fi
        shell: bash

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.go == '1.23'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          fail_ci_if_error: false

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build
        run: go build -v ./...

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -d .
            exit 1
          fi

  vet:
    name: Go Vet
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run go vet
        run: go vet ./...

  integration-aws:
    name: AWS Integration Tests (LocalStack)
    runs-on: ubuntu-latest
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: secretsmanager
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Wait for LocalStack
        run: |
          echo "Waiting for LocalStack to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:4566/_localstack/health 2>/dev/null | grep -q "secretsmanager.*available"; do sleep 2; done'
          echo "LocalStack is ready"

      - name: Run AWS integration tests
        env:
          LOCALSTACK_ENDPOINT: http://localhost:4566
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_REGION: us-east-1
        run: |
          go test -v -race -coverprofile=coverage-aws.out ./backends/awssecrets/
          go tool cover -func=coverage-aws.out | grep total

      - name: Upload AWS coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage-aws.out
          flags: integration-aws
          fail_ci_if_error: false

  integration-gcp:
    name: GCP Integration Tests (Mock)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build GCP mock server
        run: |
          echo "Building GCP Secret Manager mock server..."
          go build -o gcp-mock ./cmd/gcp-secret-manager-mock
          echo "Built successfully"

      - name: Start GCP mock server
        run: |
          echo "Starting GCP mock server on port 9090..."
          ./gcp-mock --port 9090 > gcp-mock.log 2>&1 &
          MOCK_PID=$!
          echo $MOCK_PID > gcp-mock.pid
          echo "Started with PID: $MOCK_PID"
          sleep 2
          if ps -p $MOCK_PID > /dev/null; then
            echo "GCP mock server is running"
            cat gcp-mock.log
          else
            echo "Failed to start GCP mock server"
            cat gcp-mock.log
            exit 1
          fi

      - name: Run GCP integration tests
        env:
          GCP_MOCK_ENDPOINT: localhost:9090
        run: |
          go test -v -race -coverprofile=coverage-gcp.out ./backends/gcpsecrets/
          go tool cover -func=coverage-gcp.out | grep total

      - name: Stop GCP mock server
        if: always()
        run: |
          if [ -f gcp-mock.pid ]; then
            kill $(cat gcp-mock.pid) 2>/dev/null || true
          fi

      - name: Upload GCP coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage-gcp.out
          flags: integration-gcp
          fail_ci_if_error: false
